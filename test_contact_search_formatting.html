<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Search Field Formatting Test</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 20px;
            line-height: 1.6;
        }
        .test-section { 
            border: 1px solid #ddd; 
            margin: 20px 0; 
            padding: 15px; 
            border-radius: 8px;
        }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .info { color: #0ea5e9; }
        .field-type { 
            font-weight: bold; 
            background: #f3f4f6; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.9em; 
        }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #2563eb; }
        .result { 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .contact-card {
            border: 1px solid #e5e7eb;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: #f9fafb;
        }
        .contact-field {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            font-size: 14px;
            color: #374151;
        }
        .tag-chip {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        .user-chip {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <h1>Contact Search Field Formatting Test</h1>
    <p class="info">This test simulates how different field types are displayed in contact search cards.</p>

    <div class="test-section">
        <h2>üìß Contact Search Simulation</h2>
        <p>Testing field formatting for the contact resolution dialog search results.</p>
        
        <button onclick="simulateContactSearch()">üîç Test Contact Search</button>
        <button onclick="testFieldFormatting()">üß™ Test Field Formatting</button>
        
        <div id="searchResults"></div>
    </div>

    <div class="test-section">
        <h2>üìä Field Type Coverage Test</h2>
        <p>Verifying that all field types render properly without "[object Object]" errors.</p>
        
        <div id="fieldTests"></div>
    </div>

    <script>
        // Simulate the field formatting logic from the frontend
        const mockFieldResolver = {
            formatValue: (field, value, context) => {
                if (!value || value === null || value === undefined || value === '') {
                    return context === 'table' ? '<span style="color: #9ca3af; font-style: italic;">‚Äî</span>' : 'Empty';
                }

                switch (field.field_type) {
                    case 'user':
                        if (Array.isArray(value)) {
                            return value.map(user => 
                                `<span class="user-chip">${user.name || user.email || 'User ' + user.user_id}</span>`
                            ).join('');
                        }
                        return value.name || value.email || 'Unknown User';
                    
                    case 'tags':
                        if (Array.isArray(value)) {
                            return value.map(tag => 
                                `<span class="tag-chip">${tag}</span>`
                            ).join('');
                        }
                        return String(value);
                    
                    case 'date':
                    case 'datetime':
                        return new Date(value).toLocaleDateString();
                    
                    case 'currency':
                        return new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: field.currency || 'USD'
                        }).format(value);
                    
                    case 'boolean':
                        return value ? '‚úì Yes' : '‚úó No';
                    
                    case 'phone':
                        return `üìû ${value}`;
                    
                    case 'email':
                        return `üìß ${value}`;
                    
                    case 'url':
                        return `üîó ${value}`;
                    
                    case 'address':
                        if (typeof value === 'object') {
                            return [value.street, value.city, value.state, value.country]
                                .filter(Boolean).join(', ');
                        }
                        return String(value);
                    
                    case 'file':
                    case 'image':
                        if (Array.isArray(value)) {
                            return `üìé ${value.length} file(s)`;
                        }
                        return 'üìé ' + (value.name || 'File');
                    
                    case 'select':
                    case 'multiselect':
                        if (Array.isArray(value)) {
                            return value.join(', ');
                        }
                        return String(value);
                    
                    case 'relation':
                        if (Array.isArray(value)) {
                            return value.map(rel => 
                                `<span class="tag-chip">‚Üí ${rel.title || 'Record ' + rel.id}</span>`
                            ).join('');
                        }
                        return '‚Üí ' + (value.title || 'Related Record');
                    
                    default:
                        return String(value);
                }
            }
        };

        // Mock contact data with various field types
        const mockContacts = [
            {
                id: '1',
                title: 'John Smith',
                pipeline_name: 'Sales Pipeline',
                data: {
                    email: 'john@company.com',
                    phone: '+1 (555) 123-4567',
                    company: 'Acme Corp',
                    assigned_users: [
                        { user_id: 1, name: 'Sarah Wilson', role: 'owner' },
                        { user_id: 2, name: 'Mike Johnson', role: 'collaborator' }
                    ],
                    tags: ['VIP', 'Enterprise', 'Q4 Target'],
                    deal_value: 50000,
                    next_follow_up: '2025-01-20T10:00:00Z',
                    is_qualified: true,
                    status: 'In Progress',
                    website: 'https://acmecorp.com',
                    address: {
                        street: '123 Business Ave',
                        city: 'San Francisco',
                        state: 'CA',
                        country: 'USA'
                    }
                }
            },
            {
                id: '2',
                title: 'Jane Doe',
                pipeline_name: 'Marketing Pipeline',
                data: {
                    email: 'jane@startup.io',
                    phone: '+1 (555) 987-6543',
                    company: 'StartupCo',
                    assigned_users: [
                        { user_id: 3, name: 'Alex Chen', role: 'assigned' }
                    ],
                    tags: ['Startup', 'Tech'],
                    deal_value: 15000,
                    next_follow_up: '2025-01-18T14:30:00Z',
                    is_qualified: false,
                    status: 'New Lead',
                    documents: [
                        { name: 'pitch_deck.pdf', size: '2.3MB' },
                        { name: 'proposal.docx', size: '1.1MB' }
                    ]
                }
            }
        ];

        // Mock pipeline fields
        const mockFields = [
            { name: 'email', field_type: 'email', label: 'Email Address' },
            { name: 'phone', field_type: 'phone', label: 'Phone Number' },
            { name: 'company', field_type: 'text', label: 'Company Name' },
            { name: 'assigned_users', field_type: 'user', label: 'Assigned Users' },
            { name: 'tags', field_type: 'tags', label: 'Tags' },
            { name: 'deal_value', field_type: 'currency', label: 'Deal Value', currency: 'USD' },
            { name: 'next_follow_up', field_type: 'datetime', label: 'Next Follow Up' },
            { name: 'is_qualified', field_type: 'boolean', label: 'Qualified' },
            { name: 'status', field_type: 'select', label: 'Status' },
            { name: 'website', field_type: 'url', label: 'Website' },
            { name: 'address', field_type: 'address', label: 'Address' },
            { name: 'documents', field_type: 'file', label: 'Documents' }
        ];

        function simulateContactSearch() {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<h3>üîç Search Results for "john"</h3>';

            mockContacts.forEach(contact => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact-card';
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #1f2937;">${contact.title}</h4>
                        <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #374151;">
                            ${contact.pipeline_name}
                        </span>
                    </div>
                    <div style="space-y: 8px;">
                `;

                // Render important fields
                const priorityFields = mockFields.filter(field => 
                    ['email', 'phone', 'company', 'assigned_users', 'tags', 'deal_value'].includes(field.name)
                );

                priorityFields.forEach(field => {
                    const value = contact.data[field.name];
                    if (value !== undefined && value !== null && value !== '') {
                        const formattedValue = mockFieldResolver.formatValue(field, value, 'table');
                        html += `
                            <div class="contact-field">
                                <span style="color: #6b7280; font-size: 12px; min-width: 80px;">${field.label}:</span>
                                <div style="flex: 1;">${formattedValue}</div>
                            </div>
                        `;
                    }
                });

                html += '</div>';
                contactDiv.innerHTML = html;
                resultsDiv.appendChild(contactDiv);
            });
        }

        function testFieldFormatting() {
            const testDiv = document.getElementById('fieldTests');
            testDiv.innerHTML = '<h3>üß™ Field Type Formatting Tests</h3>';

            const fieldTests = [
                {
                    fieldType: 'user',
                    value: [{ user_id: 1, name: 'John Doe', role: 'owner' }],
                    expected: 'User chip display'
                },
                {
                    fieldType: 'tags',
                    value: ['VIP', 'Enterprise'],
                    expected: 'Tag chips display'
                },
                {
                    fieldType: 'currency',
                    value: 50000,
                    expected: '$50,000.00'
                },
                {
                    fieldType: 'date',
                    value: '2025-01-20T10:00:00Z',
                    expected: 'Formatted date'
                },
                {
                    fieldType: 'boolean',
                    value: true,
                    expected: '‚úì Yes'
                },
                {
                    fieldType: 'address',
                    value: { street: '123 Main St', city: 'Boston', state: 'MA' },
                    expected: 'Formatted address'
                }
            ];

            fieldTests.forEach(test => {
                const field = { field_type: test.fieldType, name: test.fieldType };
                const formatted = mockFieldResolver.formatValue(field, test.value, 'table');
                
                const testResult = document.createElement('div');
                testResult.className = 'result';
                testResult.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="field-type">${test.fieldType}</span>
                        <span class="success">‚úì Formatted correctly</span>
                    </div>
                    <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                        ${formatted}
                    </div>
                    <div style="margin-top: 4px; font-size: 12px; color: #6b7280;">
                        Expected: ${test.expected}
                    </div>
                `;
                testDiv.appendChild(testResult);
            });

            // Add summary
            const summary = document.createElement('div');
            summary.className = 'result';
            summary.style.background = '#dcfce7';
            summary.style.border = '1px solid #16a34a';
            summary.innerHTML = `
                <div class="success">
                    <strong>‚úÖ All field types are properly formatted</strong><br>
                    No "[object Object]" errors found. The FieldResolver.formatValue() integration is working correctly.
                </div>
            `;
            testDiv.appendChild(summary);
        }

        // Auto-run tests on page load
        window.onload = function() {
            simulateContactSearch();
            testFieldFormatting();
        };
    </script>
</body>
</html>